{% extends "index.html" %}
{% load static i18n %}

{% block title %}
  <title>Exoset - {% trans "Administration GitHub" %} </title>
{% endblock %}
{% block content %}
  <h2>{% trans "List of the exercises on Exoset database" %}</h2>
  <p>{% trans "This list includes the exercises in the Exoset database. Use the corresponding link to modify the metadata." %}</p>
  <p id="information_message"><strong></strong></p>
{% if resourcesourcefile_list %}
  <table id="example" class="table table-striped">
  <thead>
    <tr>
                <th colspan="2" >{% trans "Title" %}</th>
                <th  >{% trans "access resource" %}</th>
                <th colspan="2" >{% trans "Resource visible on exoset" %}</th>
                <th>{% trans "Missing fields" %}</th>
            </tr>
  </thead>
  <tbody>
  {% for resource in resourcesourcefile_list %}
    <tr>
      <td colspan="2">{{ resource.resource.title }} </td>

      <td><a href="{% url 'githubadmin:metadata_creation' resource.resource.id resource.file_name %}"> {{ resource.file_name }}</a></td>
      <td colspan="2">
        <span style="display: none">{{ resource.resource.visible }}</span>
        <form class="make_visible_resource" id="{{ resource.resource.id }}">
          {% csrf_token %}
          <input type="radio" id="yes" name="visibility" value="True" {% if resource.resource.visible == True %} checked {% endif %} onclick="test_submission({{ resource.resource.id }}, 'True')"><label for="yes">{% trans "Yes" %}</label>
          <input type="radio" id="no" name="visibility" value="False" {% if resource.resource.visible == False %} checked {% endif %} onclick="test_submission({{ resource.resource.id }}, 'False')"><label for="no">{% trans "No" %}</label>
          <!--<input type="submit" class="btn btn-primary" value="Change" />-->
        </form>
      </td>
      <td><span id="message_{{ resource.resource.id }}">{% if resource.resource.missing_fields_resource %}{{ resource.resource.missing_fields_resource }}{% endif %}</span></td>
    </tr>
  {% endfor %}
  </tbody>
  </table>
  {% endif %}
  <h2>{% trans "List of the exercises only on Github" %}</h2>
  <p>{% trans "This list includes the exercises in the Github repository but not yet in exoset database. Metadata must be created" %}</p>
  {% if new_exercises %}
  <table>
  <thead>
  <tr>
                <th>{% trans "Title folder" %}</th>
                <th>{% trans "Create resource" %}</th>

            </tr>
  {% for resource in new_exercises %}
    <tr>
      <td>{{ resource }} </td>
      <td><a href="{% url 'githubadmin:metadata_creation' None resource %}"> {% trans "Access" %}</a></td>
    </tr>
  {% endfor %}
  </thead>
  <tbody>

  </tbody>
  </table>
  {% else %}
  <p>{% trans "No new exercise on Github" %}</p>
  {% endif %}

  <script>
  $('th').click(function(){
    var table = $(this).parents('table').eq(0)
    var rows = table.find('tr:gt(0)').toArray().sort(comparer($(this).index()))
    this.asc = !this.asc
    if (!this.asc){rows = rows.reverse()}
    for (var i = 0; i < rows.length; i++){table.append(rows[i])}
})
function comparer(index) {
    return function(a, b) {
        var valA = getCellValue(a, index), valB = getCellValue(b, index)
        return $.isNumeric(valA) && $.isNumeric(valB) ? valA - valB : valA.toString().localeCompare(valB)
    }
}
function getCellValue(row, index){ return $(row).children('td').eq(index).text() }

  function test_submission(pk_form, value_visible){
    var url_link = "{% url 'githubadmin:publish_resource' %}"
    $.ajax({
                type : "POST",
                url: url_link,
                data: {
                 visible: value_visible,
                 id_resource: pk_form,
                 csrfmiddlewaretoken: '{{ csrf_token }}',
                 dataType: "json",
                },

                success: function(data){
                  var message = data['success']
                  var info = data['information']
                   $('#message_'+ pk_form).html($('<strong>'+ message + '</strong>'))
                   $('#information_message').html($('<strong>'+ info + '</strong>'))
                },

                failure: function() {
                  console.log('failure')
                }


            });

  }

      </script>
{% endblock %}

<script>
$(document).ready(function() {
    $('#example').DataTable();

} );
</script>

